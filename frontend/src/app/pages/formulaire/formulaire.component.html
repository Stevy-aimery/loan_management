<div class="formulaire-container">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8">
        <!-- En-tête avec titre -->
        <div class="text-center mb-4">
          <h2 class="fw-bold" [style.color]="getActionColor()">
            <i [class]="'bi ' + getActionIcon() + ' me-2'"></i>{{ getActionText() }} d'appareil
          </h2>
          <p class="text-muted">Veuillez remplir le formulaire ci-dessous</p>
        </div>
        
        <!-- Carte principale -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-body p-4">
            <!-- Onglets -->
            <ul class="nav nav-tabs mb-4">
              <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab === 'emprunt'" (click)="changeTab('emprunt')" href="javascript:void(0)">
                  <i class="bi bi-box-arrow-in-down me-2"></i>Emprunt
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab === 'restitution'" (click)="changeTab('restitution')" href="javascript:void(0)">
                  <i class="bi bi-box-arrow-in-up me-2"></i>Restitution
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" [class.active]="activeTab === 'signalement'" (click)="changeTab('signalement')" href="javascript:void(0)">
                  <i class="bi bi-exclamation-triangle me-2"></i>Signalement
                </a>
              </li>
            </ul>
            
            <!-- Message d'erreur -->
            <div *ngIf="error" class="alert alert-danger mb-4">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
            </div>
            
            <!-- Message de succès -->
            <div *ngIf="success" class="alert alert-success mb-4">
              <i class="bi bi-check-circle-fill me-2"></i>{{ getActionText() }} enregistré avec succès !
            </div>
            
            <!-- Chargement -->
            <div *ngIf="loading" class="text-center py-5">
              <div class="spinner-border" [style.color]="getActionColor()" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
              <p class="mt-3 text-muted">Traitement en cours...</p>
            </div>
            
            <!-- Formulaire -->
            <form *ngIf="!loading && !success" [formGroup]="loanForm" (ngSubmit)="onSubmit()">
              <!-- Informations sur l'appareil -->
              <div class="mb-4">
                <h5 class="fw-bold mb-3" [style.color]="getActionColor()">
                  <i class="bi bi-laptop me-2"></i>Informations sur l'appareil
                </h5>
                
                <div class="row">
                  <!-- Image de l'appareil -->
                  <div class="col-md-4 mb-3 mb-md-0" *ngIf="device && device.imageUrl">
                    <div class="d-flex flex-column align-items-center">
                      <div class="device-image-container">
                        <img [src]="device.imageUrl" alt="Image de l'appareil" class="img-fluid rounded" style="max-height: 150px;" onerror="this.src='/assets/images/devices/device-placeholder.png'; this.onerror=null;">
                      </div>
                    </div>
                  </div>
                  
                  <!-- Détails de l'appareil -->
                  <div [class]="device && device.imageUrl ? 'col-md-8' : 'col-12'" *ngIf="device">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <div class="form-floating">
                          <input type="text" class="form-control" id="reference" [value]="device.reference" readonly placeholder="Référence">
                          <label for="reference">Référence</label>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-floating">
                          <input type="text" class="form-control" id="marque" [value]="device.marque" readonly placeholder="Marque">
                          <label for="marque">Marque</label>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-floating">
                          <input type="text" class="form-control" id="type" [value]="device.type" readonly placeholder="Type">
                          <label for="type">Type</label>
                        </div>
                      </div>
                      
                      <!-- État du matériel -->
                      <div class="col-12 mt-3">
                        <div class="form-floating">
                          <input type="text" class="form-control" 
                                id="etat_materiel" 
                                [value]="device.etat" 
                                readonly
                                placeholder="État du matériel">
                          <label for="etat_materiel">État du matériel</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Informations sur le demandeur -->
              <div class="mb-4">
                <h5 class="fw-bold mb-3" [style.color]="getActionColor()">
                  <i class="bi bi-person me-2"></i>Informations sur le demandeur
                </h5>
                
                <!-- Recherche utilisateur -->
                <div class="mb-3">
                  <label for="searchUser" class="form-label">Rechercher un utilisateur existant</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchUser" [formControl]="searchUserControl" placeholder="Rechercher par nom, prénom ou email">
                  </div>
                  
                  <!-- Résultats de recherche -->
                  <div *ngIf="searchingUsers" class="mt-2 text-center">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                      <span class="visually-hidden">Recherche...</span>
                    </div>
                    <span class="ms-2 text-muted">Recherche d'utilisateurs...</span>
                  </div>
                  
                  <div *ngIf="filteredUsers.length > 0" class="mt-2 search-results">
                    <div *ngFor="let user of filteredUsers" class="search-result-item p-2" (click)="selectUser(user)">
                      <div class="d-flex align-items-center">
                        <div class="avatar-circle me-2">
                          {{ user.prenom.charAt(0) }}{{ user.nom.charAt(0) }}
                        </div>
                        <div>
                          <div class="fw-bold">{{ user.prenom }} {{ user.nom }}</div>
                          <div class="text-muted small">{{ user.email }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control" 
                             id="nom" 
                             formControlName="nom" 
                             placeholder="Nom"
                             [class.is-invalid]="isFieldInvalid('nom')">
                      <label for="nom">Nom</label>
                      <div *ngIf="isFieldInvalid('nom')" class="invalid-feedback">
                        {{ getErrorMessage('nom') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="text" class="form-control" 
                             id="prenom" 
                             formControlName="prenom" 
                             placeholder="Prénom"
                             [class.is-invalid]="isFieldInvalid('prenom')">
                      <label for="prenom">Prénom</label>
                      <div *ngIf="isFieldInvalid('prenom')" class="invalid-feedback">
                        {{ getErrorMessage('prenom') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="email" class="form-control" 
                             id="email" 
                             formControlName="email" 
                             placeholder="Email"
                             [class.is-invalid]="isFieldInvalid('email')"
                             (blur)="searchUserByEmail()">
                      <label for="email">Email</label>
                      <div *ngIf="isFieldInvalid('email')" class="invalid-feedback">
                        {{ getErrorMessage('email') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-floating">
                      <input type="tel" class="form-control" 
                             id="telephone" 
                             formControlName="telephone" 
                             placeholder="Téléphone"
                             [class.is-invalid]="isFieldInvalid('telephone')">
                      <label for="telephone">Téléphone</label>
                      <div *ngIf="isFieldInvalid('telephone')" class="invalid-feedback">
                        {{ getErrorMessage('telephone') }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Informations spécifiques à l'action -->
              <div class="mb-4">
                <h5 class="fw-bold mb-3" [style.color]="getActionColor()">
                  <i [class]="'bi ' + getActionIcon() + ' me-2'"></i>Informations sur {{ getActionText().toLowerCase() }}
                </h5>
                
                <!-- Emprunt -->
                <div *ngIf="activeTab === 'emprunt'">
                  <div class="mb-3">
                    <div class="form-floating">
                      <textarea class="form-control" 
                                id="motif_emprunt" 
                                formControlName="motif_emprunt" 
                                placeholder="Motif d'emprunt"
                                style="height: 100px"
                                [class.is-invalid]="isFieldInvalid('motif_emprunt')"></textarea>
                      <label for="motif_emprunt">Motif d'emprunt</label>
                      <div *ngIf="isFieldInvalid('motif_emprunt')" class="invalid-feedback">
                        {{ getErrorMessage('motif_emprunt') }}
                      </div>
                    </div>
                  </div>
                  
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="form-floating">
                        <input type="date" class="form-control" 
                               id="date_emprunt" 
                               formControlName="date_emprunt" 
                               placeholder="Date d'emprunt"
                               readonly
                               [class.is-invalid]="isFieldInvalid('date_emprunt')">
                        <label for="date_emprunt">Date d'emprunt</label>
                        <div *ngIf="isFieldInvalid('date_emprunt')" class="invalid-feedback">
                          {{ getErrorMessage('date_emprunt') }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        <input type="date" class="form-control" 
                               id="date_restitution" 
                               formControlName="date_restitution" 
                               placeholder="Date de restitution prévue"
                               readonly
                               [class.is-invalid]="isFieldInvalid('date_restitution')">
                        <label for="date_restitution">Date de restitution prévue</label>
                        <div *ngIf="isFieldInvalid('date_restitution')" class="invalid-feedback">
                          {{ getErrorMessage('date_restitution') }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Restitution -->
                <div *ngIf="activeTab === 'restitution'">
                  <div class="mb-3">
                    <div class="form-floating">
                      <textarea class="form-control" 
                                id="motif_restitution" 
                                formControlName="motif_restitution" 
                                placeholder="Motif de restitution"
                                style="height: 100px"
                                [class.is-invalid]="isFieldInvalid('motif_restitution')"></textarea>
                      <label for="motif_restitution">Motif de restitution</label>
                      <div *ngIf="isFieldInvalid('motif_restitution')" class="invalid-feedback">
                        {{ getErrorMessage('motif_restitution') }}
                      </div>
                    </div>
                  </div>
                  
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="form-floating">
                        <input type="date" class="form-control" 
                               id="date_restitution_reelle" 
                               formControlName="date_restitution_reelle" 
                               placeholder="Date de restitution"
                               readonly
                               [class.is-invalid]="isFieldInvalid('date_restitution_reelle')">
                        <label for="date_restitution_reelle">Date de restitution</label>
                        <div *ngIf="isFieldInvalid('date_restitution_reelle')" class="invalid-feedback">
                          {{ getErrorMessage('date_restitution_reelle') }}
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-floating">
                        <textarea class="form-control" 
                                  id="commentaire" 
                                  formControlName="commentaire" 
                                  placeholder="Commentaire"
                                  style="height: 100px"></textarea>
                        <label for="commentaire">Commentaire (optionnel)</label>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Signalement -->
                <div *ngIf="activeTab === 'signalement'">
                  <div class="mb-3">
                    <label for="etat_appareil" class="form-label">État de l'appareil</label>
                    <select class="form-select" 
                            id="etat_appareil" 
                            formControlName="etat_appareil"
                            [class.is-invalid]="isFieldInvalid('etat_appareil')">
                      <option value="" disabled selected>Sélectionnez l'état de l'appareil</option>
                      <option *ngFor="let option of etatOptions" [value]="option.value">{{ option.label }}</option>
                    </select>
                    <div *ngIf="isFieldInvalid('etat_appareil')" class="invalid-feedback">
                      {{ getErrorMessage('etat_appareil') }}
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <div class="form-floating">
                      <textarea class="form-control" 
                                id="description_signalement" 
                                formControlName="description_signalement" 
                                placeholder="Description du problème"
                                style="height: 120px"
                                [class.is-invalid]="isFieldInvalid('description_signalement')"></textarea>
                      <label for="description_signalement">Description du problème</label>
                      <div *ngIf="isFieldInvalid('description_signalement')" class="invalid-feedback">
                        {{ getErrorMessage('description_signalement') }}
                      </div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <div class="form-floating">
                      <textarea class="form-control" 
                                id="commentaire" 
                                formControlName="commentaire" 
                                placeholder="Commentaire supplémentaire"
                                style="height: 100px"></textarea>
                      <label for="commentaire">Commentaire supplémentaire (optionnel)</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Boutons d'action -->
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-outline-secondary me-md-2" (click)="cancel()">
                  <i class="bi bi-x-circle me-2"></i>Annuler
                </button>
                <button type="submit" class="btn btn-primary" [style.background-color]="getActionColor()" style="border: none;">
                  <i class="bi bi-check-circle me-2"></i>Valider
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>